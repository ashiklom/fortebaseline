---
title: "FoRTE baseline"
author:
  - Alexey N. Shiklomanov
  - Jeff Atkins
  - Ben Bond-Lamberty
  - Christopher M. Gough
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::html_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/ecology.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---

```{r, setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/"
)

library(fortebaseline) # Or use devtools::load_all('.', quiet = T) if your code is in script files, rather than as functions in the `/R` diretory
```

# Introduction

Earth's climate is changing, and its terrestrial ecosystems are likely to be affected (REF: IPCC).
Many of these ecosystems will be affected through persistent changes in their environment, for instance through elevated atmospheric CO~2~ concentrations and temperature, changing precipitation regimes (REF).
At the same time, climate change is likely change the frequency and severity of disturbances [@dale_2001_climate], and the impacts of these changes may be more acute.

<!-- Add something positive about each of these? Then, the section about models is more compelling. -->
In trying to anticipate future changes to terrestrial ecosystems, ecologists have four general techniques.
One approach is to look to the past to see how ecosystems responded to similar changes (REFs).
This is challenging for two reasons:
For one, we often have to look very far back to find similar climate changes, and the techniques we have for determining the state of ecosystems in the distant past have limited detail (REF).
More importantly, there are few (if any) times where the climate has changed as rapidly as it is now, and it is unclear whether slower changes in the past will trigger responses similar to the faster changes happening now (REF).
A second approach is space-for-time substitution, whereby we use existing climatic gradients through space (e.g. with latitude or elevation) to infer the corresponding changes through time (REF).
However, many processes that drive spatial variation in ecosystems play out over hundreds or thousands of years (e.g. evolution), far longer than policy-relevant timescales of years to decades and far slower than the current pace of climate change (REF).
A third approach is to conduct experimental manipulations, where individuals are subjected to controlled changes in environmental conditions [@medlyn_2015_using].
Because they are able to isolate specific changes by controlling for most other factors, experiments are very useful for testing mechanisms.
Unfortunately, resource constraints limit the spatial and temporal extent of experiments, and emerging evidence from (the relatively few) long-term experiments suggests that short-term results cannot always be extrapolated from longer-term results [@reich_2018_unexpected].

The fourth approach is to use computer models based on existing understanding of ecosystem function.
Models unconstrained by data are little more than thought experiments with limited value to decision-making.
However, models provide a useful tool for confronting hypotheses with observations from a variety of sources, including the three described above [@dietze_2013_improving].

Model design involves an invariable trade-off between complexity and predictive uncertainty.
The more processes are represented in a model (and the more parameters are used to represent those processes), the higher the uncertainty in the "true" value of each parameter, and the higher the uncertainty in model predictions (especially out of sample) (REF -- information theory, e.g. AIC?).
On the other hand, simplistic models often fail to match important properties of the observations.
A key challenge in model development is to find the balance between these two extremes.


Big leaf models (e.g. CLM) fail to capture vegetation dynamics (REF).
This is due to their inability to represent demographic processes, which are important (REF).
An emerging class of models can simulate vegetation demographic processes, including competition for resources within a patch, recruitment, and mortality [@fisher_2017_vegetation].
Individually-based models are one possibility (REFs -- Shugart, Ensheng Wang, etc.).
However, they are complicated (REF).
An alternative are models of intermediate complexity ("middle ground"), which use approximations.
One such approximation is the "Ecosystem Demography" approach, whereby groups of individuals ("cohorts") of similar species, size, and structure are modeled together, and the statistical properties of these cohorts are modeled rather than the characteristics of each individual [@moorcroft_2001_method].

One realization of this is the Ecosystem Demography (v2) model [@moorcroft_2001_method; @medvigy_2011_predicting; @medvigy_2009_mechanistic].
This model has been used to simulate (examples...).


Net ecosystem productivity (NEP) declines immediately after disturbance, but recovers in 10-20 years [@amiro_2010_ecosystem].
Extent of recovery depends on balance of gross (aboveground?) primary productivity (GPP) and respiration; GPP increase during recovery, while respiration may stay constant [@amiro_2010_ecosystem].

<!--
TODO: Also discuss the other ED modules.
-->

This manuscript addresses the following research questions:
(Q1) To what extent can the ED2 model reproduce 100 years of observed succession (or observed _anything_) at UMBS starting from bare ground?
(Q2) How does the inclusion of various processes affect the accuracy and predictive uncertainty of ED2 predictions?
(Q3) What drives the predictive uncertainty of the ED2 model at UMBS, and what additional observations are necessary to improve predictions / constrain uncertainty?

Based on previous results [@fisher_2015_taking], we predict ED2 will over-predict dominance of early-successional canopy species (and under-predict understory productivity) under its default configuration.
Enabling dynamic N cycling and a finite canopy radius model will alleviate these issues, but will significantly increase the parameteric uncertainty due to strong sensitivity to N-cycling and canopy gap fraction parameters, respectively.
Constraining these parameters should be a high priority 

## ED modules

(NOTE: Not a real section; just brainstorming notes for now)

- Big leaf model (no demographics) (`IBIGLEAF`)
    - Simplistic case
    - Only one PFT per patch (by definition). Can ask: Does it get the right one?
    - Compare fluxes against other cases.
- Branches (`IBRANCH_THERMO`)
    - Options:
        - (0) No branches in energy balance or biophysics
        - (1; default) Branches in energy balance, but not biophysics
        - (2) Branches in both
    - In theory, should be a minor component of the energy balance, so impact should be small. This is the hypothesis?
- Temperature variation of physiology (`IPHYSIOL`)
    - Options:
        - (0) Arrhenius function, `Gamma*` based on Foley et al. (1996) (TODO: REF)
        - (1) Arrhenius, `Gamma*` based on Michaelis-Mentel coefficients for CO2 and O2, as in Farquhar et al. (1980) (TODO: REF)
        - (2; default) Q10 equations and parameters of Collatz et al. (1991), with MM coefficients. High/low temperature correction in Moorcroft et al. (2001)
        - (3) As (2), but `Gamma*` as in Farquhar et al. (1980) and CLM.
    - Need to do some exploratory analysis here. Grab the relevant equations and coefficients and plot them (outside of ED) to compare behavior.
        - Possible angle: More important at temperature extremes?
    - Consult @rogers_2016_roadmap for inspiration
- Finite canopy radius (`CROWN_MOD`)
    - Options:
        - (0; default): Complete shading
        - (1): Finite canopy radius (Dietze 2008)
    - See current hypotheses
- Soil decomposition temperature sensitivity (`DECOMP_SCHEME`)
    - Options:
        - (0; default): Exponential
        - (1) Lloyd and Taylor (1994)
    - (1) requires additional parameters, so should increase parameteric uncertainty.
    - Hypothesis: Affects overall GPP/R~E~ balance, but not successional dynamics.
- Water limitation of photosynthesis (`H2O_PLANT_LIM`)
    - Options:
        - (0) No limitation.
        - (1; default): Supply is total soil water above wilting point integrated across all levels in rooting zone.
        - (2): Supply is total soil water at field capacity minus wilting point, scaled by "wilting factor":
          ```
          # k -- Soil layer
          # z -- Layer depth
          # psi -- Matric potential (for layer, or at wp or fc)
          # wp -- wilting point
          # fc -- field capacity
          (psi(k) - (H - z(k)) - psi_wp) / (psi_fc - psi_wp)
          ```
    - Sensitivity should depend on site climate and soil conditions.
    - UMBS are pretty wet sites, so shouldn't expect a huge effect.
- Structural growth (`ISTRUCT_GROWTH_SCHEME`)
    - Options:
        - (0; default) Use all `bstorage` (NSC?)
        - (1) Reserve `bstorage` to re-flush canopy and fine roots once before calculating structural growth.
    - (1) is a more conservative strategy, so should reduce the growth and relative dominance of early-successional PFTs. In particular, growth rate should decline more with size (because more LAI and fine roots means more reserves needed).
- Stomatal conductance model (`ISTOMATA_SCHEME`)
    - Options:
        - (0, default): Leuning
        - (1) Katul optimization model (see Xu et al. 2016 New Phyt.)
    - Need to read more about this...
- Trait plasticity (`TRAIT_PLASTICITY_SCHEME`)
    - Options:
        - (0, default): Static traits
        - (1) Vm0 (SLA) decrease (increase) with shading, based on Lloyd et al. (2010 Biogeosciences). Updated yearly.
        - (2) Same as (1), but updated monthly
        - (-1) Same as 1, but adjust SLA using height
        - (-2) Same as (2), but adjust SLA using height
    - If trait plasticity is optimal, this should reduce (?) the relative dominance of early-successional PFTs.
    - Probably introduces considerable predictive uncertainty, given new parameters for plasticity models.
- Carbon balance contribution to mortality (`IDDMORT_SCHEME`)
    - Options:
        - (0, default): Carbon balance in terms of fluxes only
        - (1) Carbon balance is offset by storage pool (i.e. carbon storage is an additional buffer against mortality)
    - Additional protection from (1) should reduce mortality for all trees, so will probably reinforce dominance of early successional trees?
    - But likely to interact with other schemes, especially structural growth, which determines size of NSC reserves
- Carbon stress scheme (`CBR_SCHEME`)
    - Options:
        - (0, default): Single stress, with maximum carbon balance determined at full sun and no moisture
        - (1) Co-limitation of light and moisture; calculate `cb/cb_lightmax` and `cb/cb_moistmax`, and weight based on `DDMORT_CONST` (tunable global[?] parameter)
        - (2) "Leibig style"; limitation based on whether soil or light are more important (`cb/max(cb_lightmax, cb_moistmax)`)
    - No idea about this one. Need to do more reading.
- Quantum yield model (`QUANTUM_EFFICIENCY_T`)
    - Options:
        - (0, default): Constant quantum efficiency
        - (1): Quantum efficiency varies with temperature, based on Ehleringer (1978) (TODO: Get ref)
    - Uncertainty should increase with (1) assuming parameters are tunable. 
    - Depends on where UMBS conditions fall within the range of temperatures. Good candidate for exploratory analysis outside of ED.
- Nitrogen limitation of photosynthesis (`N_PLANT_LIM`)
    - Options:
        - (0, default): No limitation
        - (1) Limitation based on internal model (TODO: what is it?)
    - Turning this on _should_ favor mid-successional species, and substantially increase uncertainty.
- Nitrogen limitation of decomposition (`N_PLANT_LIM`)
    - Options:
        - (0, default): No limitation
        - (1) Limitation based on internal model (TODO: what is it?)
    - Same as above
- Canopy roughness model (`ICANTURB`)
    - Options:
        - (0): Based on Leuning et al. (1995; TODO REF). Wind computed using "similarity theory" for top cohort, then extinguished with cumulative LAI.
        - (1, default) "Default ED2.1 scheme" (TODO: 0? Figure it out!), but using "zero-plane" displacement height.
        - (2) Massman (1997; TODO) using constant drag and no sheltering factor
        - (3) Also Massman, but with varying drag and sheltering within canopy
        - (4) Like 0, but calculate ground conductance following CLM (eq. 5.98-5.100)
    - No idea, except that (3) will have higher uncertainty than (2). Need to read more about this.
- Similarity theory model (for canopy roughness) (`ISFCLYRM`)
    - Computes `u*`, `T*`, etc.
    - Options:
        - (1) BRAMS default, based on Louis (1979 TODO). 
        - (2) Oncley and Dudhia (1995 TODO), based on MM5
        - (3) Beljaars and Holtslag (1991 TODO); Like (2), but alternative method for stable case that has more mixing
        - (4, default) CLM (2004; TODO: Check that this is same as 2013?). Like (2) and (3), but with special functions to deal with very stable cases.
    - Again, no idea. Need to read more about micro-meteorology and how it affects vegetation processes.
- Ground to canopy conductance (`IED_GRNDVAP`)
    - Options:
        - (0, default): Modified Lee Pielke (1992 TODO), with field capacity, but with beta factor without square (as in Noilhan and Planton 1989 TODO). Like original ED2 and LEAF-3.
        - (1-4) Mahfouf and Noilhan (1991 TODO), #1-4
        - (5) Combination of (1) (alpha) and (2) (soil resistance)
    - No idea. Again, need to do some micro-met reading.
- Percolation and infiltration (`IPERCOL`)
    - Options:
        - (0) Constant soil conductivity. Temporary surface water (only exists if top soil layer is saturated) exceeding 1:9 liquid:ice ratio shed via percolation.
        - (1, default) Constant soil conductivity, with percolation model from Anderson (1976 NOAA technical report NWS 19 TODO). Temporary surface water can exist after heavy rain event even if soil doesn't saturate.
        - (2) Like (1), but soil conductivity decreases with depth even under constant soil moisture
    - Presumably, not a huge impact at UMBS because water shouldn't be an issue.
    - See also `RUNOFF_TIME` (e-folding lifetime of temporary surface water)
- Tree-fall disturbance rate (`TREEFALL_DISTURBANCE_RATE`)
    - Options:
        - (0, default) No treefall disturbance
        - (> 0) Disturbance rate, in 1/years. Will create new patches.
        - (< 0) Also rate, but will be added to mortality (kill plants, but no new patches)
    - Reference value for this is 0.014 trees year^-1^ (note that because of ED's cohort approximation, number of individuals is continuous, not discrete)
    - See also `TIME2CANOPY`, minimum age for tree-fall disturbance.
- Growth respiration (`GROWTH_RESP_SCHEME`)
    - Options:
        - (0, default) Growth respiration is a tax on GPP, at PFT-specific rate. Treated as aboveground wood to canopy-airspace flux.
        - (1) Growth respiration calculated as in (0), but split into leaf, sapwood-a, sapwood-b, and root sources proportionally to biomass. No effect on overall C budget, but greater within-ecosystem flux resolution.
    - These should produce identical results, and if they don't, that means there is a bug!
    - If output is identical, we should set to (1), since we can always calculate total respiration otherwise.
- Storage respiration (`STORAGE_RESP_SCHEME`) -- same as growth
    - Note that this whole system is a _hack_, because there is no real "storage respiration" process. In PEcAn, we hard-code the relevant parameters to zero. An interesting question is whether we may be able to get better results with this hack enabled -- i.e. if it compensates a problem in some other process.
- Other configs that ED has, but that we will probably ignore:
    - Allometry (`IALLOM`) -- Seems to mostly affect tropical PFTs. Worth checking.
    - Grass (`IGRASS`) -- I'm not running with any grass PFTs.
    - Phenology (`IPHEN_SCHEME`) -- Differences affect grasses and tropical species. Conifers are always evergreen, and hardwoods are always cold-deciduous (need to check that schemes are the same).
    - Seed dispersal (`REPRO_SCHEME`) -- Only seems to matter for multi-site runs, with some toggles for tropical (drought-deciduous) species.
    - Hydrodynamics (`PLANT_HYDRO_SCHEME`) -- Seems mostly tropics-focused? Look into the Xu et al. (2016; New Phyt.) paper.
    - Fire disturbance (`INCLUDE_FIRE`) -- We know there weren't any fires at UMBS during this time, and more generally are interested in stability.
        - This could potentially be fun to play with in a later paper about disturbance regimes. Potentially, with Jackie Matthes?
    - Anthropogenic disturbances (`IANTH_DISTURB`) -- We are currently looking at stable state, without disturbances. But, since this pulls values from a dataset, this could be one way to apply the FoRTE treatments.

# Methods

## Site description

- Secondary successional forest -- bigtooth aspen (_Populus grandidentata_), northern red oak (_Quercus rubra_), red maple (/Acer rubrum/), paper birch (_Betula papyrifera_), eastern white pine (_Pinus strobus_)
- Average age -- 95 years (2013)
- NEP in UMBS tower is 1.58 MG C ha-1 yr-1 (0.80-1.98) (1999-2006), but with landscape variation (REF?)
- Heavily logged in late 1800s and early 1900s, disturbed by fire until 1923
- Present day composition typical of upper Great Lakes region
- Previously, the site of the FASET experiment [@gough_2013_sustained; @gough_2008_multi]

## Model description: ED2

The Ecosystem Demography Model, version 2 (ED2) [@medvigy_2009_mechanistic].

Summary of common features (can move into supplement if necessary):

- Cohort-based scaling approach
- Photosynthesis / stomatal conductance
- Allometries

In this study, we run a factorial experiment of ED2 with the following features enabled or disabled:

- Radiative transfer
  - Two-stream model
    - Same general approach as in CLM 4.5 [@clm45_note], but rather than solving for just two layers (sunlit and shaded), solve for each canopy layer.
    - Set up the two-stream equations for each layer as a linear system and solve the entire set of equations numerically
    - Similar to approaches used in other models: JULES [@mercado_2007_improving], ORCHIDEE-CAN [@naudts_2015_vertically], CLM(SPA) [@bonan_2014_modeling]
  - Multiple scatter model **TODO**

# Results

```{r get-data, eval = FALSE}
# Note the path that we need to use to access our data files when rendering this document
my_data <- readr::read_csv("../data/raw_data/my_csv_file.csv")
```

# Discussion

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? You may need to change the path value
# if your Rmd is not in analysis/paper/
git2r::repository("../..")
```
